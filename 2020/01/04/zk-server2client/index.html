<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="概述Zookeeper 中服务端的通信又可分为服务端与服务端之间的通信和服务端和客户端之间的通信，本章节着重解析服务端和客户端之间的通信，及源码分析。 服务端架构图 核心类介绍zk服务端分为单机模式、集群模式，本章因为着重分析服务端与客户端通信，所以使用单机模式作为源码解析，以避开集群模式相关代码的干扰。  ZooKeeperServerMain ：ZkServer 核心启动类 ServerCnx">
<meta property="og:type" content="article">
<meta property="og:title" content="Zookeeper -- 服务端与客户端网络通信源码分析">
<meta property="og:url" content="http://example.com/2020/01/04/zk-server2client/index.html">
<meta property="og:site_name" content="温故而知新">
<meta property="og:description" content="概述Zookeeper 中服务端的通信又可分为服务端与服务端之间的通信和服务端和客户端之间的通信，本章节着重解析服务端和客户端之间的通信，及源码分析。 服务端架构图 核心类介绍zk服务端分为单机模式、集群模式，本章因为着重分析服务端与客户端通信，所以使用单机模式作为源码解析，以避开集群模式相关代码的干扰。  ZooKeeperServerMain ：ZkServer 核心启动类 ServerCnx">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/zk-server2client/image-zk-framework.png">
<meta property="og:image" content="http://example.com/images/zk-server2client/5871751-92c0da6dc6ea8287.png">
<meta property="article:published_time" content="2020-01-04T16:00:00.000Z">
<meta property="article:modified_time" content="2022-05-11T13:27:38.360Z">
<meta property="article:author" content="tlv">
<meta property="article:tag" content="Zookeeper">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/zk-server2client/image-zk-framework.png">

<link rel="canonical" href="http://example.com/2020/01/04/zk-server2client/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Zookeeper -- 服务端与客户端网络通信源码分析 | 温故而知新</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">温故而知新</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">7</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">8</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/01/04/zk-server2client/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="tlv">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温故而知新">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Zookeeper -- 服务端与客户端网络通信源码分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-05 00:00:00" itemprop="dateCreated datePublished" datetime="2020-01-05T00:00:00+08:00">2020-01-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-11 21:27:38" itemprop="dateModified" datetime="2022-05-11T21:27:38+08:00">2022-05-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Distributed/" itemprop="url" rel="index"><span itemprop="name">Distributed</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Distributed/Zookeeper/" itemprop="url" rel="index"><span itemprop="name">Zookeeper</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>32k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>29 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Zookeeper 中服务端的通信又可分为服务端与服务端之间的通信和服务端和客户端之间的通信，本章节着重解析服务端和客户端之间的通信，及源码分析。</p>
<h2 id="服务端架构图"><a href="#服务端架构图" class="headerlink" title="服务端架构图"></a>服务端架构图</h2><p><img src="/images/zk-server2client/image-zk-framework.png" alt="image-zk-framework"></p>
<h2 id="核心类介绍"><a href="#核心类介绍" class="headerlink" title="核心类介绍"></a>核心类介绍</h2><p>zk服务端分为单机模式、集群模式，本章因为着重分析服务端与客户端通信，所以使用单机模式作为源码解析，以避开集群模式相关代码的干扰。</p>
<ul>
<li>ZooKeeperServerMain ：ZkServer 核心启动类</li>
<li>ServerCnxnFactory ：服务端连接管理器工厂（工厂模式）</li>
<li>NettyServerCnxnFactory ：服务端连接管理器工厂 Netty 实现（ServerCnxnFactory 实现类）</li>
<li>NettyServerCnxn ：单条连接的服务端连接管理器 Netty 实现</li>
<li>RequestProcessor ：请求处理器接口，实现该接口类可用作 Request Processor Pipeline 中的节点</li>
</ul>
<h2 id="服务端启动流程"><a href="#服务端启动流程" class="headerlink" title="服务端启动流程"></a>服务端启动流程</h2><ol>
<li>配置文件解析</li>
<li>初始化数据管理器</li>
<li>初始化网络I/O管理器</li>
<li>数据恢复</li>
<li>对外服务</li>
</ol>
<p><img src="/images/zk-server2client/5871751-92c0da6dc6ea8287.png" alt="启动流程图"></p>
<h2 id="单机模式启动流程概述"><a href="#单机模式启动流程概述" class="headerlink" title="单机模式启动流程概述"></a>单机模式启动流程概述</h2><ol>
<li>配置文件解析</li>
<li>创建并启动历史文件清理器</li>
<li>初始化数据管理器</li>
<li>注册shutdownHandler</li>
<li>启动Admin server</li>
<li>创建并启动网络IO管理器</li>
<li>启动ZooKeeperServer</li>
<li>创建并启动secureCnxnFactory</li>
<li>创建并启动ContainerManager</li>
</ol>
<h2 id="单机启动源码解析"><a href="#单机启动源码解析" class="headerlink" title="单机启动源码解析"></a>单机启动源码解析</h2><ol>
<li><p>代码入口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.quorum.QuorumPeerMain#main</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">QuorumPeerMain</span> <span class="variable">main</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QuorumPeerMain</span>();</span><br><span class="line">        <span class="comment">// 服务端启动入口</span></span><br><span class="line">  			 <span class="keyword">try</span> &#123;</span><br><span class="line">    			<span class="comment">// 根据命令行参数初始化并运行 Zookeeper 服务端</span></span><br><span class="line">    			main.initializeAndRun(args);</span><br><span class="line">    		&#125; </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>配置文件解析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.quorum.QuorumPeerMain#initializeAndRun</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initializeAndRun</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ConfigException, IOException, AdminServerException &#123;</span><br><span class="line">        <span class="comment">// 1.解析配置文件</span></span><br><span class="line">        <span class="type">QuorumPeerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QuorumPeerConfig</span>();</span><br><span class="line">        <span class="keyword">if</span> (args.length == <span class="number">1</span>) &#123;</span><br><span class="line">            config.parse(args[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start and schedule the the purge task</span></span><br><span class="line">        <span class="comment">// 2.创建并启动历史文件清理器(对事务日志和快照数据文件进行定时清理)</span></span><br><span class="line">        <span class="type">DatadirCleanupManager</span> <span class="variable">purgeMgr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatadirCleanupManager</span>(</span><br><span class="line">            config.getDataDir(),</span><br><span class="line">            config.getDataLogDir(),</span><br><span class="line">            config.getSnapRetainCount(),</span><br><span class="line">            config.getPurgeInterval());</span><br><span class="line">        purgeMgr.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (args.length == <span class="number">1</span> &amp;&amp; config.isDistributed()) &#123;</span><br><span class="line">            <span class="comment">// 集群启动</span></span><br><span class="line">            runFromConfig(config);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Either no config or no quorum defined in config, running in standalone mode&quot;</span>);</span><br><span class="line">            <span class="comment">// there is only server in the quorum -- run as standalone</span></span><br><span class="line">            <span class="comment">// 单机启动</span></span><br><span class="line">            ZooKeeperServerMain.main(args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>启动流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.ZooKeeperServerMain#runFromConfig</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">runFromConfig</span><span class="params">(ServerConfig config)</span> <span class="keyword">throws</span> IOException, AdminServerException &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;Starting server&quot;</span>);</span><br><span class="line">        <span class="type">FileTxnSnapLog</span> <span class="variable">txnLog</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                metricsProvider = MetricsProviderBootstrap.startMetricsProvider(</span><br><span class="line">                    config.getMetricsProviderClassName(),</span><br><span class="line">                    config.getMetricsProviderConfiguration());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (MetricsProviderLifeCycleException error) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Cannot boot MetricsProvider &quot;</span> + config.getMetricsProviderClassName(), error);</span><br><span class="line">            &#125;</span><br><span class="line">            ServerMetrics.metricsProviderInitialized(metricsProvider);</span><br><span class="line">            ProviderRegistry.initialize();</span><br><span class="line">            <span class="comment">// Note that this thread isn&#x27;t going to be doing anything else,</span></span><br><span class="line">            <span class="comment">// so rather than spawning another thread, we will just call</span></span><br><span class="line">            <span class="comment">// run() in this thread.</span></span><br><span class="line">            <span class="comment">// create a file logger url from the command line args</span></span><br><span class="line">            <span class="comment">// 3.创建ZooKeeper数据管理器</span></span><br><span class="line">            txnLog = <span class="keyword">new</span> <span class="title class_">FileTxnSnapLog</span>(config.dataLogDir, config.dataDir);</span><br><span class="line">            <span class="type">JvmPauseMonitor</span> <span class="variable">jvmPauseMonitor</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (config.jvmPauseMonitorToRun) &#123;</span><br><span class="line">                jvmPauseMonitor = <span class="keyword">new</span> <span class="title class_">JvmPauseMonitor</span>(config);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建 Zookeeper 服务端实例</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">ZooKeeperServer</span> <span class="variable">zkServer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZooKeeperServer</span>(jvmPauseMonitor, txnLog, config.tickTime, config.minSessionTimeout, config.maxSessionTimeout, config.listenBacklog, <span class="literal">null</span>, config.initialConfig);</span><br><span class="line">            <span class="comment">// 将 Zookeeper 服务端实例与本地事务文件存储进行绑定</span></span><br><span class="line">            txnLog.setServerStats(zkServer.serverStats());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Registers shutdown handler which will be used to know the</span></span><br><span class="line">            <span class="comment">// server error or shutdown state changes.</span></span><br><span class="line">            <span class="comment">// 4.注册shutdownHandler,在ZooKeeperServer的状态变化时调用shutdownHandler的handle()</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">shutdownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">            zkServer.registerServerShutdownHandler(<span class="keyword">new</span> <span class="title class_">ZooKeeperServerShutdownHandler</span>(shutdownLatch));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start Admin server</span></span><br><span class="line">            <span class="comment">// 5.启动Admin server</span></span><br><span class="line">            adminServer = AdminServerFactory.createAdminServer();</span><br><span class="line">            adminServer.setZooKeeperServer(zkServer);</span><br><span class="line">            adminServer.start();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 6.创建并启动网络IO管理器</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">needStartZKServer</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (config.getClientPortAddress() != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 通过静态方法 createFactory 创建 ServerCnxnFactory 实例</span></span><br><span class="line">                cnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">                <span class="comment">// 根据配置文件中的 ClientPostAddress 配置其客户端端口</span></span><br><span class="line">                cnxnFactory.configure(config.getClientPortAddress(), config.getMaxClientCnxns(), config.getClientPortListenBacklog(), <span class="literal">false</span>);</span><br><span class="line">                <span class="comment">// 使用 ServerCnxnFactory 启动 zookeeperServer</span></span><br><span class="line">                cnxnFactory.startup(zkServer);</span><br><span class="line">                <span class="comment">// zkServer has been started. So we don&#x27;t need to start it again in secureCnxnFactory.</span></span><br><span class="line">                <span class="comment">// 因为在此处 zkServer 已经启动，所以我们不需要在 secureCnxnFactory 中再次启动它</span></span><br><span class="line">                needStartZKServer = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 8.创建并启动secureCnxnFactory</span></span><br><span class="line">            <span class="keyword">if</span> (config.getSecureClientPortAddress() != <span class="literal">null</span>) &#123;</span><br><span class="line">                secureCnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">                secureCnxnFactory.configure(config.getSecureClientPortAddress(), config.getMaxClientCnxns(), config.getClientPortListenBacklog(), <span class="literal">true</span>);</span><br><span class="line">                secureCnxnFactory.startup(zkServer, needStartZKServer);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 9.创建并启动ContainerManager</span></span><br><span class="line">            containerManager = <span class="keyword">new</span> <span class="title class_">ContainerManager</span>(</span><br><span class="line">                zkServer.getZKDatabase(),</span><br><span class="line">                zkServer.firstProcessor,</span><br><span class="line">                Integer.getInteger(<span class="string">&quot;znode.container.checkIntervalMs&quot;</span>, (<span class="type">int</span>) TimeUnit.MINUTES.toMillis(<span class="number">1</span>)),</span><br><span class="line">                Integer.getInteger(<span class="string">&quot;znode.container.maxPerMinute&quot;</span>, <span class="number">10000</span>),</span><br><span class="line">                Long.getLong(<span class="string">&quot;znode.container.maxNeverUsedIntervalMs&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            );</span><br><span class="line">            containerManager.start();</span><br><span class="line">            ZKAuditProvider.addZKStartStopAuditLog();</span><br><span class="line"></span><br><span class="line">            serverStarted();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Watch status of ZooKeeper server. It will do a graceful shutdown</span></span><br><span class="line">            <span class="comment">// if the server is not running or hits an internal error.</span></span><br><span class="line">            <span class="comment">// 服务器正常启动时,运行到此处阻塞,只有server的state变为ERROR或SHUTDOWN时继续运行后面的代码</span></span><br><span class="line">            shutdownLatch.await();</span><br><span class="line"></span><br><span class="line">            shutdown();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cnxnFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">                cnxnFactory.join();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (secureCnxnFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">                secureCnxnFactory.join();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (zkServer.canShutdown()) &#123;</span><br><span class="line">                zkServer.shutdown(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="comment">// warn, but generally this is ok</span></span><br><span class="line">            LOG.warn(<span class="string">&quot;Server interrupted&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (txnLog != <span class="literal">null</span>) &#123;</span><br><span class="line">                txnLog.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (metricsProvider != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    metricsProvider.stop();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable error) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">&quot;Error while stopping metrics&quot;</span>, error);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>ServerCnxnFactory（有两个实现模式NIOServerCnxnFactory、NettyServerCnxnFactory）以NettyServerCnxnFactory代码分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.ServerCnxnFactory#createFactory()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ServerCnxnFactory <span class="title function_">createFactory</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 从配置文件中获取将要创建的 ServerCnxnFactory 类型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">serverCnxnFactoryName</span> <span class="operator">=</span> System.getProperty(ZOOKEEPER_SERVER_CNXN_FACTORY);</span><br><span class="line">        <span class="keyword">if</span> (serverCnxnFactoryName == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果系统配置文件中未设置该属性则默认使用 JDK 的 NIO 实现版本 NIOServerCnxnFactory</span></span><br><span class="line">            serverCnxnFactoryName = NIOServerCnxnFactory.class.getName();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 通过反射调用构造方法实例化 ServerCnxnFactory 对象</span></span><br><span class="line">            <span class="type">ServerCnxnFactory</span> <span class="variable">serverCnxnFactory</span> <span class="operator">=</span> (ServerCnxnFactory) Class.forName(serverCnxnFactoryName)</span><br><span class="line">                                                                           .getDeclaredConstructor()</span><br><span class="line">                                                                           .newInstance();</span><br><span class="line">            LOG.info(<span class="string">&quot;Using &#123;&#125; as server connection factory&quot;</span>, serverCnxnFactoryName);</span><br><span class="line">            <span class="keyword">return</span> serverCnxnFactory;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="type">IOException</span> <span class="variable">ioe</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Couldn&#x27;t instantiate &quot;</span> + serverCnxnFactoryName, e);</span><br><span class="line">            <span class="keyword">throw</span> ioe;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.ServerCnxnFactory#startup(org.apache.zookeeper.server.ZooKeeperServer)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startup</span><span class="params">(ZooKeeperServer zkServer)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 启动 zkServer</span></span><br><span class="line">        startup(zkServer, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NettyServerCnxnFactory#startup</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startup</span><span class="params">(ZooKeeperServer zks, <span class="type">boolean</span> startServer)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 绑定 Netty 监听端口</span></span><br><span class="line">        start();</span><br><span class="line">        <span class="comment">// 完成 zkServer 和 ServerCnxnFactory 的双向绑定</span></span><br><span class="line">        setZooKeeperServer(zks);</span><br><span class="line">        <span class="keyword">if</span> (startServer) &#123;</span><br><span class="line">            <span class="comment">// 启动 zkServer</span></span><br><span class="line">            zks.startdata();</span><br><span class="line">            zks.startup();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.NettyServerCnxnFactory#start</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (listenBacklog != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 设置半连队列大小</span></span><br><span class="line">            bootstrap.option(ChannelOption.SO_BACKLOG, listenBacklog);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;binding to port &#123;&#125;&quot;</span>, localAddress);</span><br><span class="line">        <span class="comment">// 绑定端口</span></span><br><span class="line">        parentChannel = bootstrap.bind(localAddress).syncUninterruptibly().channel();</span><br><span class="line">        <span class="comment">// Port changes after bind() if the original port was 0, update</span></span><br><span class="line">        <span class="comment">// localAddress to get the real port.</span></span><br><span class="line">        localAddress = (InetSocketAddress) parentChannel.localAddress();</span><br><span class="line">        LOG.info(<span class="string">&quot;bound to port &#123;&#125;&quot;</span>, getLocalPort());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.ServerCnxnFactory#setZooKeeperServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setZooKeeperServer</span><span class="params">(ZooKeeperServer zks)</span> &#123;</span><br><span class="line">        <span class="comment">// zkServer 和 ServerCnxnFactory 的双向绑定</span></span><br><span class="line">        <span class="built_in">this</span>.zkServer = zks;</span><br><span class="line">        <span class="keyword">if</span> (zks != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (secure) &#123;</span><br><span class="line">                zks.setSecureServerCnxnFactory(<span class="built_in">this</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                zks.setServerCnxnFactory(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>配置 Netty</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">NettyServerCnxnFactory() &#123;</span><br><span class="line">        x509Util = <span class="keyword">new</span> <span class="title class_">ClientX509Util</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">usePortUnification</span> <span class="operator">=</span> Boolean.getBoolean(PORT_UNIFICATION_KEY);</span><br><span class="line">        LOG.info(<span class="string">&quot;&#123;&#125;=&#123;&#125;&quot;</span>, PORT_UNIFICATION_KEY, usePortUnification);</span><br><span class="line">        <span class="keyword">if</span> (usePortUnification) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                QuorumPeerConfig.configureSSLAuth();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (QuorumPeerConfig.ConfigException e) &#123;</span><br><span class="line">                LOG.error(<span class="string">&quot;unable to set up SslAuthProvider, turning off client port unification&quot;</span>, e);</span><br><span class="line">                usePortUnification = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.shouldUsePortUnification = usePortUnification;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.advancedFlowControlEnabled = Boolean.getBoolean(NETTY_ADVANCED_FLOW_CONTROL);</span><br><span class="line">        LOG.info(<span class="string">&quot;&#123;&#125; = &#123;&#125;&quot;</span>, NETTY_ADVANCED_FLOW_CONTROL, <span class="built_in">this</span>.advancedFlowControlEnabled);</span><br><span class="line"></span><br><span class="line">        setOutstandingHandshakeLimit(Integer.getInteger(OUTSTANDING_HANDSHAKE_LIMIT, -<span class="number">1</span>));</span><br><span class="line">        <span class="comment">// bossGroup处理客户端的连接请求，workerGroup负责每个连接IO事件的处理，典型的reactor模式</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> NettyUtils.newNioOrEpollEventLoopGroup(NettyUtils.getClientReachableLocalInetAddressCount());</span><br><span class="line">        <span class="comment">// 创建 workerGroup 且优先选择使用更高性能的 EpollEventLoopGroup</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> NettyUtils.newNioOrEpollEventLoopGroup();</span><br><span class="line">        <span class="comment">// 创建ServerBootstrap 配置 handler</span></span><br><span class="line">        <span class="type">ServerBootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>().group(bossGroup, workerGroup)</span><br><span class="line">                                                         .channel(NettyUtils.nioOrEpollServerSocketChannel())</span><br><span class="line">                                                         <span class="comment">// parent channel options</span></span><br><span class="line">                                                         .option(ChannelOption.SO_REUSEADDR, <span class="literal">true</span>)</span><br><span class="line">                                                         <span class="comment">// child channels options</span></span><br><span class="line">                                                         .childOption(ChannelOption.TCP_NODELAY, <span class="literal">true</span>)</span><br><span class="line">                                                         .childOption(ChannelOption.SO_LINGER, -<span class="number">1</span>)</span><br><span class="line">                                                         .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                                                             <span class="meta">@Override</span></span><br><span class="line">                                                             <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                                                                 <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                                                                 <span class="keyword">if</span> (advancedFlowControlEnabled) &#123;</span><br><span class="line">                                                                     pipeline.addLast(readIssuedTrackingHandler);</span><br><span class="line">                                                                 &#125;</span><br><span class="line">                                                                 <span class="keyword">if</span> (secure) &#123;</span><br><span class="line">                                                                     initSSL(pipeline, <span class="literal">false</span>);</span><br><span class="line">                                                                 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shouldUsePortUnification) &#123;</span><br><span class="line">                                                                     initSSL(pipeline, <span class="literal">true</span>);</span><br><span class="line">                                                                 &#125;</span><br><span class="line">                                                                 <span class="comment">// 向 pipeline 添加 channelHandler 处理器</span></span><br><span class="line">                                                                 pipeline.addLast(<span class="string">&quot;servercnxnfactory&quot;</span>, channelHandler);</span><br><span class="line">                                                             &#125;</span><br><span class="line">                                                         &#125;);</span><br><span class="line">        <span class="built_in">this</span>.bootstrap = configureBootstrapAllocator(bootstrap);</span><br><span class="line">        <span class="built_in">this</span>.bootstrap.validate();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>ZooKeeperServer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.ZooKeeperServer#startup</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">startup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 启动zkServer 并设置为 RUNNING 状态</span></span><br><span class="line">        startupWithServerState(State.RUNNING);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.ZooKeeperServer#startupWithServerState</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startupWithServerState</span><span class="params">(State state)</span> &#123;</span><br><span class="line">        <span class="comment">// session 管理</span></span><br><span class="line">        <span class="keyword">if</span> (sessionTracker == <span class="literal">null</span>) &#123;</span><br><span class="line">            createSessionTracker();</span><br><span class="line">        &#125;</span><br><span class="line">        startSessionTracker();</span><br><span class="line">        <span class="comment">// 请求前置处理器，是一个生产消费队列，对每个请求状态码进行判断，分别进行请求前置处理</span></span><br><span class="line">        setupRequestProcessors();</span><br><span class="line"></span><br><span class="line">        startRequestThrottler();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册jmx bean</span></span><br><span class="line">        registerJMX();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// jvm停止监控，默认不开启</span></span><br><span class="line">        startJvmPauseMonitor();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过zxdb和zkserver填写相关指标</span></span><br><span class="line">        registerMetrics();</span><br><span class="line"></span><br><span class="line">        setState(state);</span><br><span class="line"></span><br><span class="line">        requestPathMetricsCollector.start();</span><br><span class="line"></span><br><span class="line">        localSessionEnabled = sessionTracker.isLocalSessionsEnabled();</span><br><span class="line"></span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>CnxnChannelHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.NettyServerCnxnFactory.CnxnChannelHandler</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CnxnChannelHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelDuplexHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当服务端接受客户端的socket连接之后，channelActive会被调用</span></span><br><span class="line">        <span class="comment">// 正常情况下通过channelActive服务端session层的连接表示对象会被建立起来</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                LOG.trace(<span class="string">&quot;Channel active &#123;&#125;&quot;</span>, ctx.channel());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> ctx.channel();</span><br><span class="line">            <span class="comment">// 连接数有没有达到服务端设置的连接最大数，如果达到了，直接关闭底层socket，拒绝新的连接请求</span></span><br><span class="line">            <span class="keyword">if</span> (limitTotalNumberOfCnxns()) &#123;</span><br><span class="line">                ServerMetrics.getMetrics().CONNECTION_REJECTED.add(<span class="number">1</span>);</span><br><span class="line">                channel.close();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">InetAddress</span> <span class="variable">addr</span> <span class="operator">=</span> ((InetSocketAddress) channel.remoteAddress()).getAddress();</span><br><span class="line">            <span class="comment">// 单个客户端的连接数是不是超过了用户设置的最大可建立连接数，如果达到了拒绝客户端的连接请求</span></span><br><span class="line">            <span class="keyword">if</span> (maxClientCnxns &gt; <span class="number">0</span> &amp;&amp; getClientCnxnCount(addr) &gt;= maxClientCnxns) &#123;</span><br><span class="line">                ServerMetrics.getMetrics().CONNECTION_REJECTED.add(<span class="number">1</span>);</span><br><span class="line">                LOG.warn(<span class="string">&quot;Too many connections from &#123;&#125; - max is &#123;&#125;&quot;</span>, addr, maxClientCnxns);</span><br><span class="line">                channel.close();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建session会话层的连接表示对象NettyServerCnxn</span></span><br><span class="line">            <span class="type">NettyServerCnxn</span> <span class="variable">cnxn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyServerCnxn</span>(channel, zkServer, NettyServerCnxnFactory.<span class="built_in">this</span>);</span><br><span class="line">            <span class="comment">// 将 NettyServerCnxn 保存至 Channel 属性中（接收请求时会用到）</span></span><br><span class="line">            ctx.channel().attr(CONNECTION_ATTRIBUTE).set(cnxn);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check the zkServer assigned to the cnxn is still running,</span></span><br><span class="line">            <span class="comment">// close it before starting the heavy TLS handshake</span></span><br><span class="line">            <span class="keyword">if</span> (!cnxn.isZKServerRunning()) &#123;</span><br><span class="line">                LOG.warn(<span class="string">&quot;Zookeeper server is not running, close the connection before starting the TLS handshake&quot;</span>);</span><br><span class="line">                ServerMetrics.getMetrics().CNXN_CLOSED_WITHOUT_ZK_SERVER_RUNNING.add(<span class="number">1</span>);</span><br><span class="line">                channel.close();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (handshakeThrottlingEnabled) &#123;</span><br><span class="line">                <span class="comment">// Favor to check and throttling even in dual mode which</span></span><br><span class="line">                <span class="comment">// accepts both secure and insecure connections, since</span></span><br><span class="line">                <span class="comment">// it&#x27;s more efficient than throttling when we know it&#x27;s</span></span><br><span class="line">                <span class="comment">// a secure connection in DualModeSslHandler.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// From benchmark, this reduced around 15% reconnect time.</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">outstandingHandshakesNum</span> <span class="operator">=</span> outstandingHandshake.addAndGet(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (outstandingHandshakesNum &gt; outstandingHandshakeLimit) &#123;</span><br><span class="line">                    outstandingHandshake.addAndGet(-<span class="number">1</span>);</span><br><span class="line">                    channel.close();</span><br><span class="line">                    ServerMetrics.getMetrics().TLS_HANDSHAKE_EXCEEDED.add(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    cnxn.setHandshakeState(HandshakeState.STARTED);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (secure) &#123;</span><br><span class="line">                <span class="type">SslHandler</span> <span class="variable">sslHandler</span> <span class="operator">=</span> ctx.pipeline().get(SslHandler.class);</span><br><span class="line">                Future&lt;Channel&gt; handshakeFuture = sslHandler.handshakeFuture();</span><br><span class="line">                handshakeFuture.addListener(<span class="keyword">new</span> <span class="title class_">CertificateVerifier</span>(sslHandler, cnxn));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!shouldUsePortUnification) &#123;</span><br><span class="line">                <span class="comment">// 将 Channel 和 NettyServerCnxn 分别添加到集合中保存</span></span><br><span class="line">                allChannels.add(ctx.channel());</span><br><span class="line">                addCnxn(cnxn);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ctx.channel().pipeline().get(SslHandler.class) == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">SocketAddress</span> <span class="variable">remoteAddress</span> <span class="operator">=</span> cnxn.getChannel().remoteAddress();</span><br><span class="line">                <span class="keyword">if</span> (remoteAddress != <span class="literal">null</span></span><br><span class="line">                        &amp;&amp; !((InetSocketAddress) remoteAddress).getAddress().isLoopbackAddress()) &#123;</span><br><span class="line">                    LOG.trace(<span class="string">&quot;NettyChannelHandler channelActive: remote=&#123;&#125; local=&#123;&#125;&quot;</span>, remoteAddress, cnxn.getChannel().localAddress());</span><br><span class="line">                    zkServer.serverStats().incrementNonMTLSRemoteConnCount();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    zkServer.serverStats().incrementNonMTLSLocalConnCount();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 连接关闭时的处理逻辑</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                LOG.trace(<span class="string">&quot;Channel inactive &#123;&#125;&quot;</span>, ctx.channel());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将 Channel 从 allChannels 集合中移除</span></span><br><span class="line">            allChannels.remove(ctx.channel());</span><br><span class="line">            <span class="type">NettyServerCnxn</span> <span class="variable">cnxn</span> <span class="operator">=</span> ctx.channel().attr(CONNECTION_ATTRIBUTE).getAndSet(<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (cnxn != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                    LOG.trace(<span class="string">&quot;Channel inactive caused close &#123;&#125;&quot;</span>, cnxn);</span><br><span class="line">                &#125;</span><br><span class="line">                updateHandshakeCountIfStarted(cnxn);</span><br><span class="line">                <span class="comment">// 关闭 NettyServerCnxn</span></span><br><span class="line">                cnxn.close(ServerCnxn.DisconnectReason.CHANNEL_DISCONNECTED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 异常处理方法</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Exception caught&quot;</span>, cause);</span><br><span class="line">            <span class="type">NettyServerCnxn</span> <span class="variable">cnxn</span> <span class="operator">=</span> ctx.channel().attr(CONNECTION_ATTRIBUTE).getAndSet(<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (cnxn != <span class="literal">null</span>) &#123;</span><br><span class="line">                LOG.debug(<span class="string">&quot;Closing &#123;&#125;&quot;</span>, cnxn);</span><br><span class="line">                updateHandshakeCountIfStarted(cnxn);</span><br><span class="line">                cnxn.close(ServerCnxn.DisconnectReason.CHANNEL_CLOSED_EXCEPTION);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理用自定义的channel事件：主要是处理channel读和不读的事件</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (evt == NettyServerCnxn.ReadEvent.ENABLE) &#123;</span><br><span class="line">                    LOG.debug(<span class="string">&quot;Received ReadEvent.ENABLE&quot;</span>);</span><br><span class="line">                    <span class="type">NettyServerCnxn</span> <span class="variable">cnxn</span> <span class="operator">=</span> ctx.channel().attr(CONNECTION_ATTRIBUTE).get();</span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> Not sure if cnxn can be null here. It becomes null if channelInactive()</span></span><br><span class="line">                    <span class="comment">// or exceptionCaught() trigger, but it&#x27;s unclear to me if userEventTriggered() can run</span></span><br><span class="line">                    <span class="comment">// after either of those. Check for null just to be safe ...</span></span><br><span class="line">                    <span class="keyword">if</span> (cnxn != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (cnxn.getQueuedReadableBytes() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            cnxn.processQueuedBuffer();</span><br><span class="line">                            <span class="keyword">if</span> (advancedFlowControlEnabled &amp;&amp; cnxn.getQueuedReadableBytes() == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="comment">// trigger a read if we have consumed all</span></span><br><span class="line">                                <span class="comment">// backlog</span></span><br><span class="line">                                ctx.read();</span><br><span class="line">                                LOG.debug(<span class="string">&quot;Issued a read after queuedBuffer drained&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!advancedFlowControlEnabled) &#123;</span><br><span class="line">                        ctx.channel().config().setAutoRead(<span class="literal">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (evt == NettyServerCnxn.ReadEvent.DISABLE) &#123;</span><br><span class="line">                    LOG.debug(<span class="string">&quot;Received ReadEvent.DISABLE&quot;</span>);</span><br><span class="line">                    ctx.channel().config().setAutoRead(<span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                ReferenceCountUtil.release(evt);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 服务端读取客户端发送来的请求数据</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                    LOG.trace(<span class="string">&quot;message received called &#123;&#125;&quot;</span>, msg);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    LOG.debug(<span class="string">&quot;New message &#123;&#125; from &#123;&#125;&quot;</span>, msg, ctx.channel());</span><br><span class="line">                    <span class="comment">// channelActive时候 将NettyServerCnxn注册到的Channel 属性中</span></span><br><span class="line">                    <span class="type">NettyServerCnxn</span> <span class="variable">cnxn</span> <span class="operator">=</span> ctx.channel().attr(CONNECTION_ATTRIBUTE).get();</span><br><span class="line">                    <span class="keyword">if</span> (cnxn == <span class="literal">null</span>) &#123;</span><br><span class="line">                        LOG.error(<span class="string">&quot;channelRead() on a closed or closing NettyServerCnxn&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 如果 NettyServerCnxn 未被关闭或未被正在关闭则调用 processMessage 处理请求</span></span><br><span class="line">                        cnxn.processMessage((ByteBuf) msg);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    LOG.error(<span class="string">&quot;Unexpected exception in receive&quot;</span>, ex);</span><br><span class="line">                    <span class="keyword">throw</span> ex;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 释放 Buffer</span></span><br><span class="line">                ReferenceCountUtil.release(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (advancedFlowControlEnabled) &#123;</span><br><span class="line">                <span class="type">NettyServerCnxn</span> <span class="variable">cnxn</span> <span class="operator">=</span> ctx.channel().attr(CONNECTION_ATTRIBUTE).get();</span><br><span class="line">                <span class="keyword">if</span> (cnxn != <span class="literal">null</span> &amp;&amp; cnxn.getQueuedReadableBytes() == <span class="number">0</span> &amp;&amp; cnxn.readIssuedAfterReadComplete == <span class="number">0</span>) &#123;</span><br><span class="line">                    ctx.read();</span><br><span class="line">                    LOG.debug(<span class="string">&quot;Issued a read since we do not have anything to consume after channelReadComplete&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ctx.fireChannelReadComplete();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use a single listener instance to reduce GC</span></span><br><span class="line">        <span class="comment">// Note: this listener is only added when LOG.isTraceEnabled() is true,</span></span><br><span class="line">        <span class="comment">// so it should not do any work other than trace logging.</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> GenericFutureListener&lt;Future&lt;Void&gt;&gt; onWriteCompletedTracer = (f) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                LOG.trace(<span class="string">&quot;write success: &#123;&#125;&quot;</span>, f.isSuccess());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                promise.addListener(onWriteCompletedTracer);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">super</span>.write(ctx, msg, promise);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>接收并处理请求 NettyServerCnxn</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.NettyServerCnxn#processMessage</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">processMessage</span><span class="params">(ByteBuf buf)</span> &#123;</span><br><span class="line">        checkIsInEventLoop(<span class="string">&quot;processMessage&quot;</span>);</span><br><span class="line">        LOG.debug(<span class="string">&quot;0x&#123;&#125; queuedBuffer: &#123;&#125;&quot;</span>, Long.toHexString(sessionId), queuedBuffer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">            LOG.trace(<span class="string">&quot;0x&#123;&#125; buf &#123;&#125;&quot;</span>, Long.toHexString(sessionId), ByteBufUtil.hexDump(buf));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (throttled.get()) &#123;</span><br><span class="line">            LOG.debug(<span class="string">&quot;Received message while throttled&quot;</span>);</span><br><span class="line">            <span class="comment">// we are throttled, so we need to queue</span></span><br><span class="line">            <span class="comment">// 如果当前为限流状态则直接进行排队</span></span><br><span class="line">            <span class="keyword">if</span> (queuedBuffer == <span class="literal">null</span>) &#123;</span><br><span class="line">                LOG.debug(<span class="string">&quot;allocating queue&quot;</span>);</span><br><span class="line">                queuedBuffer = channel.alloc().compositeBuffer();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 添加至 queuedBuffer 中排队</span></span><br><span class="line">            appendToQueuedBuffer(buf.retainedDuplicate());</span><br><span class="line">            <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                LOG.trace(<span class="string">&quot;0x&#123;&#125; queuedBuffer &#123;&#125;&quot;</span>, Long.toHexString(sessionId), ByteBufUtil.hexDump(queuedBuffer));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG.debug(<span class="string">&quot;not throttled&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (queuedBuffer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 排队队列不为空 直接加入对接排队</span></span><br><span class="line">                appendToQueuedBuffer(buf.retainedDuplicate());</span><br><span class="line">                <span class="comment">// 该方法中包含对于 Channel 正在关闭时的处理逻辑，但对于响应的处理实质还是调用 receiveMessage 方法</span></span><br><span class="line">                processQueuedBuffer();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 调用 receiveMessage 处理响应</span></span><br><span class="line">                receiveMessage(buf);</span><br><span class="line">                <span class="comment">// Have to check !closingChannel, because an error in</span></span><br><span class="line">                <span class="comment">// receiveMessage() could have led to close() being called.</span></span><br><span class="line">                <span class="comment">// 必须再次检查通道是否正在关闭，因为在 receiveMessage 方法中可能出现错误而导致 close() 被调用  </span></span><br><span class="line">                <span class="keyword">if</span> (!closingChannel &amp;&amp; buf.isReadable()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                        LOG.trace(<span class="string">&quot;Before copy &#123;&#125;&quot;</span>, buf);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (queuedBuffer == <span class="literal">null</span>) &#123;</span><br><span class="line">                        queuedBuffer = channel.alloc().compositeBuffer();</span><br><span class="line">                    &#125;</span><br><span class="line">                    appendToQueuedBuffer(buf.retainedSlice(buf.readerIndex(), buf.readableBytes()));</span><br><span class="line">                    <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                        LOG.trace(<span class="string">&quot;Copy is &#123;&#125;&quot;</span>, queuedBuffer);</span><br><span class="line">                        LOG.trace(<span class="string">&quot;0x&#123;&#125; queuedBuffer &#123;&#125;&quot;</span>, Long.toHexString(sessionId), ByteBufUtil.hexDump(queuedBuffer));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p> <strong>Netty.CompositeByteBuf</strong> ：复合缓冲区是多个ByteBuf组合的视图，复合缓冲区就像一个列表，我们可以动态的添加和删除其中的 ByteBuf，可以组合多个 Buffer 对象合并成一个逻辑上的对象，避免通过传统内存拷贝的方式将几个 Buffer 合并成一个大的 Buffer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.NettyServerCnxn#receiveMessage</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">receiveMessage</span><span class="params">(ByteBuf message)</span> &#123;</span><br><span class="line">        checkIsInEventLoop(<span class="string">&quot;receiveMessage&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 当writerIndex大于readerIndex(表示ByteBuf中还有可读内容)</span></span><br><span class="line">            <span class="comment">// 且throttled为false时执行while循环体</span></span><br><span class="line">            <span class="keyword">while</span> (message.isReadable() &amp;&amp; !throttled.get()) &#123;</span><br><span class="line">                <span class="comment">// bb不为null，表示已经准备好读取message</span></span><br><span class="line">                <span class="keyword">if</span> (bb != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 其中主要的部分是判断bb的剩余空间是否大于message中的内容，</span></span><br><span class="line">                    <span class="comment">// 就是判断bb是否还有足够空间存储message内容，</span></span><br><span class="line">                    <span class="comment">// 然后设置bb的limit，之后将message内容读入bb缓冲中，</span></span><br><span class="line">                    <span class="comment">// 之后再次确定时候已经读完message内容，统计接收信息，</span></span><br><span class="line">                    <span class="comment">// 再根据是否已经初始化来处理包或者是连接请求，其中的请求内容都存储在bb中</span></span><br><span class="line">                    <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                        LOG.trace(<span class="string">&quot;message readable &#123;&#125; bb len &#123;&#125; &#123;&#125;&quot;</span>, message.readableBytes(), bb.remaining(), bb);</span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">dat</span> <span class="operator">=</span> bb.duplicate();</span><br><span class="line">                        dat.flip();</span><br><span class="line">                        LOG.trace(<span class="string">&quot;0x&#123;&#125; bb &#123;&#125;&quot;</span>, Long.toHexString(sessionId), ByteBufUtil.hexDump(Unpooled.wrappedBuffer(dat)));</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// bb剩余空间大于message中可读字节大小</span></span><br><span class="line">                    <span class="keyword">if</span> (bb.remaining() &gt; message.readableBytes()) &#123;</span><br><span class="line">                        <span class="comment">// 确定新的limit</span></span><br><span class="line">                        <span class="type">int</span> <span class="variable">newLimit</span> <span class="operator">=</span> bb.position() + message.readableBytes();</span><br><span class="line">                        bb.limit(newLimit);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 将message写入bb中</span></span><br><span class="line">                    message.readBytes(bb);</span><br><span class="line">                    <span class="comment">// 重置bb的limit</span></span><br><span class="line">                    bb.limit(bb.capacity());</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                        LOG.trace(<span class="string">&quot;after readBytes message readable &#123;&#125; bb len &#123;&#125; &#123;&#125;&quot;</span>, message.readableBytes(), bb.remaining(), bb);</span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">dat</span> <span class="operator">=</span> bb.duplicate();</span><br><span class="line">                        dat.flip();</span><br><span class="line">                        LOG.trace(<span class="string">&quot;after readbytes 0x&#123;&#125; bb &#123;&#125;&quot;</span>,</span><br><span class="line">                                  Long.toHexString(sessionId),</span><br><span class="line">                                  ByteBufUtil.hexDump(Unpooled.wrappedBuffer(dat)));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 已经读完message，表示内容已经全部接收</span></span><br><span class="line">                    <span class="keyword">if</span> (bb.remaining() == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// 翻转，可读</span></span><br><span class="line">                        bb.flip();</span><br><span class="line">                        <span class="comment">// 统计接收信息</span></span><br><span class="line">                        packetReceived(<span class="number">4</span> + bb.remaining());</span><br><span class="line"></span><br><span class="line">                        <span class="type">ZooKeeperServer</span> <span class="variable">zks</span> <span class="operator">=</span> <span class="built_in">this</span>.zkServer;</span><br><span class="line">                        <span class="comment">// Zookeeper服务器为空 抛出异常</span></span><br><span class="line">                        <span class="keyword">if</span> (zks == <span class="literal">null</span> || !zks.isRunning()) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;ZK down&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 未被初始化</span></span><br><span class="line">                        <span class="keyword">if</span> (initialized) &#123;</span><br><span class="line">                            <span class="comment">// <span class="doctag">TODO:</span> if zks.processPacket() is changed to take a ByteBuffer[],</span></span><br><span class="line">                            <span class="comment">// we could implement zero-copy queueing.</span></span><br><span class="line">                            <span class="comment">// 处理bb中包含的包信息</span></span><br><span class="line">                            zks.processPacket(<span class="built_in">this</span>, bb);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// 已经初始化</span></span><br><span class="line">                            LOG.debug(<span class="string">&quot;got conn req request from &#123;&#125;&quot;</span>, getRemoteSocketAddress());</span><br><span class="line">                            <span class="comment">// 处理连接请求</span></span><br><span class="line">                            zks.processConnectRequest(<span class="built_in">this</span>, bb);</span><br><span class="line">                            initialized = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        bb = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                        LOG.trace(<span class="string">&quot;message readable &#123;&#125; bblenrem &#123;&#125;&quot;</span>, message.readableBytes(), bbLen.remaining());</span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">dat</span> <span class="operator">=</span> bbLen.duplicate();</span><br><span class="line">                        dat.flip();</span><br><span class="line">                        LOG.trace(<span class="string">&quot;0x&#123;&#125; bbLen &#123;&#125;&quot;</span>, Long.toHexString(sessionId), ByteBufUtil.hexDump(Unpooled.wrappedBuffer(dat)));</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (message.readableBytes() &lt; bbLen.remaining()) &#123;</span><br><span class="line">                        bbLen.limit(bbLen.position() + message.readableBytes());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 4 byte 的 ByteBuffer 用于读取数据包中前 4 byte 所记录的数据包中实际数据长度</span></span><br><span class="line">                    message.readBytes(bbLen);</span><br><span class="line">                    bbLen.limit(bbLen.capacity());</span><br><span class="line">                    <span class="keyword">if</span> (bbLen.remaining() == <span class="number">0</span>) &#123;</span><br><span class="line">                        bbLen.flip();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                            LOG.trace(<span class="string">&quot;0x&#123;&#125; bbLen &#123;&#125;&quot;</span>, Long.toHexString(sessionId), ByteBufUtil.hexDump(Unpooled.wrappedBuffer(bbLen)));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 读取前 4 byte 所代表的的 Int 数值</span></span><br><span class="line">                        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> bbLen.getInt();</span><br><span class="line">                        <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                            LOG.trace(<span class="string">&quot;0x&#123;&#125; bbLen len is &#123;&#125;&quot;</span>, Long.toHexString(sessionId), len);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        bbLen.clear();</span><br><span class="line">                        <span class="keyword">if</span> (!initialized) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (checkFourLetterWord(channel, message, len)) &#123;</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (len &lt; <span class="number">0</span> || len &gt; BinaryInputArchive.maxBuffer) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Len error &quot;</span> + len);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">ZooKeeperServer</span> <span class="variable">zks</span> <span class="operator">=</span> <span class="built_in">this</span>.zkServer;</span><br><span class="line">                        <span class="keyword">if</span> (zks == <span class="literal">null</span> || !zks.isRunning()) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;ZK down&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// checkRequestSize will throw IOException if request is rejected</span></span><br><span class="line">                        zks.checkRequestSizeWhenReceivingMessage(len);</span><br><span class="line">                        <span class="comment">// 将 bb 赋值为数据包中前 4 byte Int 值长度的 ByteBuffer</span></span><br><span class="line">                        bb = ByteBuffer.allocate(len);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Closing connection to &#123;&#125;&quot;</span>, getRemoteSocketAddress(), e);</span><br><span class="line">            close(DisconnectReason.IO_EXCEPTION);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClientCnxnLimitException e) &#123;</span><br><span class="line">            <span class="comment">// Common case exception, print at debug level</span></span><br><span class="line">            ServerMetrics.getMetrics().CONNECTION_REJECTED.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            LOG.debug(<span class="string">&quot;Closing connection to &#123;&#125;&quot;</span>, getRemoteSocketAddress(), e);</span><br><span class="line">            close(DisconnectReason.CLIENT_RATE_LIMIT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>receiveMessage</strong>逻辑梳理</p>
<ol>
<li>当数据包首次进入该方法时 bb 为空，所以直接进入第二个语句块；</li>
<li>在第二个语句块中会从数据包中读入长度为 4 byte 的 ByteBuffer（ bblen = ByteBuffer.allocate(4) ），然后将其转换为一个 Int 整型值 len ；</li>
<li>根据整型值 len 申请长度为 len 的 ByteBuffer 赋值给 bb ，然后结束此轮循环；</li>
<li>进入第二轮循环时 bb 已经是长度为 len 的 ByteBuffer（ len 为数据包中有效数据的长度 ），所以进入第一个语句块；</li>
<li>在第一个语句块中会直接从传入的数据包中读长度为 len 的数据并写入到 bb 中（一次性完整的将全部有效数据读入）；</li>
<li>最后将获取到的有效数据传入 processPacket 方法中进行处理；</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.ZooKeeperServer#processPacket</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processPacket</span><span class="params">(ServerCnxn cnxn, ByteBuffer incomingBuffer)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">	<span class="comment">// We have the request, now process and setup for next</span></span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteBufferInputStream</span>(incomingBuffer);</span><br><span class="line">    <span class="type">BinaryInputArchive</span> <span class="variable">bia</span> <span class="operator">=</span> BinaryInputArchive.getArchive(bais);</span><br><span class="line">    <span class="comment">// 解析请求头至临时变量 h</span></span><br><span class="line">    <span class="type">RequestHeader</span> <span class="variable">h</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestHeader</span>();</span><br><span class="line">    h.deserialize(bia, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">    <span class="comment">// 从原缓冲区的当前位置开始创建一个新的字节缓冲区</span></span><br><span class="line">	incomingBuffer = incomingBuffer.slice();</span><br><span class="line">	<span class="keyword">if</span> (h.getType() == OpCode.auth) &#123;</span><br><span class="line">		<span class="type">AuthPacket</span> <span class="variable">authPacket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthPacket</span>();</span><br><span class="line">        ByteBufferInputStream.byteBuffer2Record(incomingBuffer, authPacket);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// 省略认证等代码...</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">        	<span class="comment">// 将数据包中的有效数据组装为 Request 请求</span></span><br><span class="line">            <span class="type">Request</span> <span class="variable">si</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>(cnxn, cnxn.getSessionId(), h.getXid(), h.getType(), incomingBuffer, cnxn.getAuthInfo());</span><br><span class="line">            si.setOwner(ServerCnxn.me);</span><br><span class="line">            <span class="comment">// 将组装好的 Request 请求通过 submitRequest 方法发送给上层逻辑处理</span></span><br><span class="line">            submitRequest(si);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cnxn.incrOutstandingRequests(h);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">submitRequest</span><span class="params">(Request si)</span> &#123;</span><br><span class="line">        enqueueRequest(si);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">enqueueRequest</span><span class="params">(Request si)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (requestThrottler == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// Since all requests are passed to the request</span></span><br><span class="line">                    <span class="comment">// processor it should wait for setting up the request</span></span><br><span class="line">                    <span class="comment">// processor chain. The state will be updated to RUNNING</span></span><br><span class="line">                    <span class="comment">// after the setup.</span></span><br><span class="line">                    <span class="keyword">while</span> (state == State.INITIAL) &#123;</span><br><span class="line">                        wait(<span class="number">1000</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">&quot;Unexpected interruption&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (requestThrottler == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Not started&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 提交请求给限流器</span></span><br><span class="line">        requestThrottler.submitRequest(si);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">submitRequest</span><span class="params">(Request request)</span> &#123;</span><br><span class="line">        <span class="comment">// 如果已停止，则删除队列</span></span><br><span class="line">        <span class="keyword">if</span> (stopping) &#123;</span><br><span class="line">            LOG.debug(<span class="string">&quot;Shutdown in progress. Request cannot be processed&quot;</span>);</span><br><span class="line">            dropRequest(request);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            request.requestThrottleQueueTime = Time.currentElapsedTime();</span><br><span class="line">            <span class="comment">// LinkedBlockingQueue 入队，最终由该线程去异步处理</span></span><br><span class="line">            submittedRequests.add(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>通过上面的tcp数据转换，将其转换为了 Request 实例，提交到队列了。接下来这个队列将被 RequestThrottler 处理，它的作用是判定是否超出了设置的最大请求数，如果超出，则作等待处理，防止下游无法应对</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">org.apache.zookeeper.server.RequestThrottler#run</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (killed) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 阻塞式获取，即只要数据被提交，就会被立即处理</span></span><br><span class="line">                <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> submittedRequests.take();</span><br><span class="line">                <span class="keyword">if</span> (Request.requestOfDeath == request) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (request.mustDrop()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Throttling is disabled when maxRequests = 0</span></span><br><span class="line">                <span class="comment">// maxRequests等于0 不开启限流控制</span></span><br><span class="line">                <span class="keyword">if</span> (maxRequests &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (!killed) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (dropStaleRequests &amp;&amp; request.isStale()) &#123;</span><br><span class="line">                            <span class="comment">// Note: this will close the connection</span></span><br><span class="line">                            dropRequest(request);</span><br><span class="line">                            ServerMetrics.getMetrics().STALE_REQUESTS_DROPPED.add(<span class="number">1</span>);</span><br><span class="line">                            request = <span class="literal">null</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 只要没达到最大限制，直接通过</span></span><br><span class="line">                        <span class="keyword">if</span> (zks.getInProcess() &lt; maxRequests) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        throttleSleep(stallTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (killed) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// A dropped stale request will be null</span></span><br><span class="line">                <span class="keyword">if</span> (request != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (request.isStale()) &#123;</span><br><span class="line">                        ServerMetrics.getMetrics().STALE_REQUESTS.add(<span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">elapsedTime</span> <span class="operator">=</span> Time.currentElapsedTime() - request.requestThrottleQueueTime;</span><br><span class="line">                    ServerMetrics.getMetrics().REQUEST_THROTTLE_QUEUE_TIME.add(elapsedTime);</span><br><span class="line">                    <span class="keyword">if</span> (shouldThrottleOp(request, elapsedTime)) &#123;</span><br><span class="line">                      request.setIsThrottled(<span class="literal">true</span>);</span><br><span class="line">                      ServerMetrics.getMetrics().THROTTLED_OPS.add(<span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 验证通过后，提交给 zkServer 处理</span></span><br><span class="line">                    zks.submitRequestNow(request);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Unexpected interruption&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">dropped</span> <span class="operator">=</span> drainQueue();</span><br><span class="line">        LOG.info(<span class="string">&quot;RequestThrottler shutdown. Dropped &#123;&#125; requests&quot;</span>, dropped);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.zookeeper.server.ZooKeeperServer#submitRequestNow</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">submitRequestNow</span><span class="params">(Request si)</span> &#123;</span><br><span class="line">        <span class="comment">// 确保处理器链已生成</span></span><br><span class="line">        <span class="keyword">if</span> (firstProcessor == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// Since all requests are passed to the request</span></span><br><span class="line">                    <span class="comment">// processor it should wait for setting up the request</span></span><br><span class="line">                    <span class="comment">// processor chain. The state will be updated to RUNNING</span></span><br><span class="line">                    <span class="comment">// after the setup.</span></span><br><span class="line">                    <span class="comment">// 因为所有的请求都被传递给请求处理器，所以应该等待请求处理器链建立完成</span></span><br><span class="line">                    <span class="comment">// 且当请求处理器链建立完成后，状态将更新为 RUNNING</span></span><br><span class="line">                    <span class="keyword">while</span> (state == State.INITIAL) &#123;</span><br><span class="line">                        wait(<span class="number">1000</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">&quot;Unexpected interruption&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (firstProcessor == <span class="literal">null</span> || state != State.RUNNING) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Not started&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 验证 sessionId</span></span><br><span class="line">            touch(si.cnxn);</span><br><span class="line">            <span class="comment">// 验证 Request 是否有效</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">validpacket</span> <span class="operator">=</span> Request.isValid(si.type);</span><br><span class="line">            <span class="keyword">if</span> (validpacket) &#123;</span><br><span class="line">                setLocalSessionFlag(si);</span><br><span class="line">                <span class="comment">// 如果 Request 有效则将其传递给请求处理链（Request Processor Pipeline）的第一个请求处理器</span></span><br><span class="line">                firstProcessor.processRequest(si);</span><br><span class="line">                <span class="keyword">if</span> (si.cnxn != <span class="literal">null</span>) &#123;</span><br><span class="line">                    incInProcess();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                LOG.warn(<span class="string">&quot;Received packet at server of unknown type &#123;&#125;&quot;</span>, si.type);</span><br><span class="line">                <span class="comment">// Update request accounting/throttling limits</span></span><br><span class="line">                requestFinished(si);</span><br><span class="line">                <span class="comment">// 该请求来自未知类型的客户端</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">UnimplementedRequestProcessor</span>().processRequest(si);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MissingSessionException e) &#123;</span><br><span class="line">            LOG.debug(<span class="string">&quot;Dropping request.&quot;</span>, e);</span><br><span class="line">            <span class="comment">// Update request accounting/throttling limits</span></span><br><span class="line">            requestFinished(si);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RequestProcessorException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Unable to process request&quot;</span>, e);</span><br><span class="line">            <span class="comment">// Update request accounting/throttling limits</span></span><br><span class="line">            requestFinished(si);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>发送Response</p>
<p>因为Zookeeper 中对于请求的处理是采用 Request Processor Pipeline 来完成的，所以对于处理请求后组装并发送响应的工作就是由最后一个 FinalRequestProcessor 来完成的，因此我们下面的源码分析就从 FinalRequestProcessor 的 processRequest 方法开始，该方法的入参为上一个 Request Processor 处理后的 Request 请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.zookeeper.server.FinalRequestProcessor#processRequest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processRequest</span><span class="params">(Request request)</span> &#123;</span><br><span class="line">	<span class="comment">// 因为重点分析发送响应流程，所以省略居多分类别处理请求并生成 hdr 响应头 和 rsp 响应体代码...</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// 在上面处理过 Request 请求后将生成的响应头和响应体作为入参调用 sendResponse 方法发送响应</span></span><br><span class="line">		cnxn.sendResponse(hdr, rsp, <span class="string">&quot;response&quot;</span>);</span><br><span class="line">		<span class="comment">// 如果 Request 的类型为 closeSession 则进入关闭逻辑</span></span><br><span class="line">		<span class="keyword">if</span> (request.type == OpCode.closeSession) &#123;</span><br><span class="line">			cnxn.sendCloseSession();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">sendResponse</span><span class="params">(ReplyHeader h, Record r, String tag,</span></span><br><span class="line"><span class="params">                        String cacheKey, Stat stat, <span class="type">int</span> opCode)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="comment">// cacheKey and stat are used in caching, which is not</span></span><br><span class="line">  <span class="comment">// implemented here. Implementation example can be found in NIOServerCnxn.</span></span><br><span class="line">  <span class="keyword">if</span> (closingChannel || !channel.isOpen()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 序列化数据</span></span><br><span class="line">  ByteBuffer[] bb = serialize(h, r, tag, cacheKey, stat, opCode);</span><br><span class="line">  <span class="type">int</span> <span class="variable">responseSize</span> <span class="operator">=</span> bb[<span class="number">0</span>].getInt();</span><br><span class="line">  bb[<span class="number">0</span>].rewind();</span><br><span class="line">  <span class="comment">// 发送数据</span></span><br><span class="line">  sendBuffer(bb);</span><br><span class="line">  decrOutstandingAndCheckThrottle(h);</span><br><span class="line">  <span class="keyword">return</span> responseSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendBuffer</span><span class="params">(ByteBuffer... buffers)</span> &#123;</span><br><span class="line">  <span class="comment">// 如果 ByteBuffer 为 closeConn 则调用 close() 进入关闭逻辑</span></span><br><span class="line">  <span class="keyword">if</span> (buffers.length == <span class="number">1</span> &amp;&amp; buffers[<span class="number">0</span>] == ServerCnxnFactory.closeConn) &#123;</span><br><span class="line">    close(DisconnectReason.CLIENT_CLOSED_CONNECTION);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将 ByteBuffer 中的数据写入 Channel 并通过 flush 将其发送    </span></span><br><span class="line">  channel.writeAndFlush(Unpooled.wrappedBuffer(buffers)).addListener(onSendBufferDoneListener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="源码总结"><a href="#源码总结" class="headerlink" title="源码总结"></a>源码总结</h2><h3 id="接收请求"><a href="#接收请求" class="headerlink" title="接收请求"></a>接收请求</h3><ol>
<li>服务端从 Netty Channel 的 channelRead 方法接收请求，并通过 NettyServerCnxn 的 processMessage 方法将其转发给当前 Channel 所绑定的 NettyServerCnxn ；</li>
<li>在 NettyServerCnxn 的 processMessage 方法中会进行限流（throttle）处理将请求 Buffer 拷贝到 queuedBuffer 中，然后调用 receiveMessage 方法对请求做进一步处理；</li>
<li>receiveMessage 方法的主要工作就是从传入的 ByteBuf 中读取有效的数据（数据包前 4 byte 记录有效数据的长度），并将其转化为 ByteBuffer 传给 ZooKeeperServer 的 processPacket 进行处理；</li>
<li>在 processPacket 方法中会从 ByteBuffer 中解析出请求头和请求体，并将其封装为 Request 后传给上层的 submitRequest 方法进行处理；</li>
<li>submitRequest 会等待第一个 Request Processor 初始化完成后进行请求的验证工作，然后将验证成功的请求传递给 Request Processor Pipeline 中的第一个 Request Processor 进行处理；</li>
</ol>
<h3 id="发送响应"><a href="#发送响应" class="headerlink" title="发送响应"></a>发送响应</h3><ol>
<li>响应的发送工作是由 Request Processor Pipeline 的最后一个 Request Processor 来完成的，在 FinalRequestProcessor 的 processRequest 方法中会根据请求的类型对传入的请求进行处理，并生成响应头和响应体传给 ServerCnxn 的 sendResponse 方法；</li>
<li>在 sendResponse 方法中会将入参的响应头和响应体组装为一个完整的响应，并将其转换为 ByteBuffer 通过 NettyServerCnxn 的 sendBuffer 方法传给 NettyServerCnxn ；</li>
<li>在 NettyServerCnxn 的 sendBuffer 方法中会进行 ByteBuffer 类型的判断，如果类型为 closeConn 则进入关闭逻辑，否则通过 Channel 的 writeAndFlush 方法将响应发送；</li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Zookeeper/" rel="tag"># Zookeeper</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/12/31/mysql-base/" rel="prev" title="MySQL -- 基础架构">
      <i class="fa fa-chevron-left"></i> MySQL -- 基础架构
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/01/04/consensus-algorithm/" rel="next" title="分布式一致性算法介绍">
      分布式一致性算法介绍 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-number">2.</span> <span class="nav-text">服务端架构图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E7%B1%BB%E4%BB%8B%E7%BB%8D"><span class="nav-number">3.</span> <span class="nav-text">核心类介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">4.</span> <span class="nav-text">服务端启动流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%95%E6%9C%BA%E6%A8%A1%E5%BC%8F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E6%A6%82%E8%BF%B0"><span class="nav-number">5.</span> <span class="nav-text">单机模式启动流程概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%95%E6%9C%BA%E5%90%AF%E5%8A%A8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-number">6.</span> <span class="nav-text">单机启动源码解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E6%80%BB%E7%BB%93"><span class="nav-number">7.</span> <span class="nav-text">源码总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82"><span class="nav-number">7.1.</span> <span class="nav-text">接收请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E5%93%8D%E5%BA%94"><span class="nav-number">7.2.</span> <span class="nav-text">发送响应</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="tlv"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">tlv</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tlv</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'http://example.com/2020/01/04/zk-server2client/',]
      });
      });
  </script>

</body>
</html>
