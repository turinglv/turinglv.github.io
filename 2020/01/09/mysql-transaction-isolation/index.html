<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="事务概念 事务就是要保证一组数据库操作，要么全部成功，要么全部失败 MySQL 中，事务支持是在引擎层实现的 MyISAM不支持事务 InnoDB支持事务    隔离性与隔离级别 事务特性：ACID（Atomicity、Consistency、Isolation、Durability） Atomicity（原子性）：事务的所有操作，要么全部完成，要么全部不完成，不会结束在某个中间环节 事务comm">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL -- 事务隔离">
<meta property="og:url" content="http://example.com/2020/01/09/mysql-transaction-isolation/index.html">
<meta property="og:site_name" content="温故而知新">
<meta property="og:description" content="事务概念 事务就是要保证一组数据库操作，要么全部成功，要么全部失败 MySQL 中，事务支持是在引擎层实现的 MyISAM不支持事务 InnoDB支持事务    隔离性与隔离级别 事务特性：ACID（Atomicity、Consistency、Isolation、Durability） Atomicity（原子性）：事务的所有操作，要么全部完成，要么全部不完成，不会结束在某个中间环节 事务comm">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/mysql-transaction-isolation/7dea45932a6b722eb069d2264d0066f8.png">
<meta property="og:image" content="http://example.com/images/mysql-transaction-isolation/882114aaf55861832b4270d44507695e.png">
<meta property="og:image" content="http://example.com/images/mysql-transaction-isolation/mysql-innodb-row-multi-version-20210606133912235.png">
<meta property="og:image" content="http://example.com/images/mysql-transaction-isolation/823acf76e53c0bdba7beab45e72e90d6.png">
<meta property="og:image" content="http://example.com/images/mysql-transaction-isolation/86ad7e8abe7bf16505b97718d8ac149f.png">
<meta property="og:image" content="http://example.com/images/mysql-transaction-isolation/86ad7e8abe7bf16505b97718d8ac149f.png">
<meta property="og:image" content="http://example.com/images/mysql-transaction-isolation/cda2a0d7decb61e59dddc83ac51efb6e.png">
<meta property="og:image" content="http://example.com/images/mysql-transaction-isolation/540967ea905e8b63630e496786d84c92.png">
<meta property="og:image" content="http://example.com/images/mysql-transaction-isolation/mysql-innodb-trx-rc-20210606162844432.png">
<meta property="og:image" content="http://example.com/images/mysql-transaction-isolation/mysql-read-view.png">
<meta property="article:published_time" content="2020-01-09T16:00:00.000Z">
<meta property="article:modified_time" content="2022-05-11T13:27:38.360Z">
<meta property="article:author" content="tlv">
<meta property="article:tag" content="Storage">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/mysql-transaction-isolation/7dea45932a6b722eb069d2264d0066f8.png">

<link rel="canonical" href="http://example.com/2020/01/09/mysql-transaction-isolation/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>MySQL -- 事务隔离 | 温故而知新</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">温故而知新</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">7</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">8</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/01/09/mysql-transaction-isolation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="tlv">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温故而知新">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MySQL -- 事务隔离
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2020-01-10T00:00:00+08:00">2020-01-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-11 21:27:38" itemprop="dateModified" datetime="2022-05-11T21:27:38+08:00">2022-05-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Storage/" itemprop="url" rel="index"><span itemprop="name">Storage</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Storage/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>7.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="事务概念"><a href="#事务概念" class="headerlink" title="事务概念"></a>事务概念</h2><ul>
<li>事务就是要保证一组数据库操作，要么全部成功，要么全部失败</li>
<li>MySQL 中，事务支持是在引擎层实现的<ul>
<li>MyISAM不支持事务</li>
<li>InnoDB支持事务</li>
</ul>
</li>
</ul>
<h2 id="隔离性与隔离级别"><a href="#隔离性与隔离级别" class="headerlink" title="隔离性与隔离级别"></a>隔离性与隔离级别</h2><ul>
<li>事务特性：<strong>ACID</strong>（Atomicity、Consistency、Isolation、Durability）<ul>
<li>Atomicity（原子性）：事务的所有操作，要么全部完成，要么全部不完成，不会结束在某个中间环节<ul>
<li>事务commit，MySQL crash或者系统宕机，可以通过redolog崩溃恢复</li>
<li>事务rollback，通过undolog进行数据恢复</li>
</ul>
</li>
<li>Consistency（一致性）：事务开始之前和事务结束之后，数据库的完整性限制未被破坏<ul>
<li>事务的一致性就是在事务定义层级（数据库、应用层、甚至多个应用）里，用AID特性和回滚手段满足了该层级的约束，即可满足该层级的C</li>
</ul>
</li>
<li>Isolation（隔离性）：每个读写事务的对象对其他事务的操作对象能相互隔离，即该事务提交前对其他事务都不可见<ul>
<li>通过MVCC、锁实现</li>
</ul>
</li>
<li>Durability（持久性）：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失<ul>
<li>通过redolog实现</li>
</ul>
</li>
</ul>
</li>
<li>数据库上有多个事务同时执行的时候，就可能出现<strong>脏读（dirty read）、不可重复读（non-repeatable read）、幻读（phantom read）</strong>的问题<ul>
<li>解决方案：<strong>隔离级别</strong></li>
<li>隔离级别越高，效率就会越低</li>
<li>脏读：读到其他事务未提交的数据</li>
<li>不可重复读：前后读取的记录内容不一致 </li>
<li>幻读：前后读取的记录数量不一致</li>
</ul>
</li>
<li>SQL的标准隔离级别：<ul>
<li><strong>READ-UNCOMMITTED（读未提交）</strong><ul>
<li>一个事务还未提交时，它所做的变更能被别的事务看到</li>
</ul>
</li>
<li><strong>READ-COMMITTED（读已提交）</strong><ul>
<li>一个事务提交之后，它所做的变更才会被其他事务看到</li>
</ul>
</li>
<li><strong>REPEATABLE-READ（可重复读）</strong><ul>
<li>一个事务在执行过程中所看到的数据，总是跟这个事务在启动时看到的数据是一致的</li>
<li>同样，在RR隔离级别下，未提交的变更对其他事务也是不可见的</li>
</ul>
</li>
<li><strong>SERIALIZABLE（串行化）</strong><ul>
<li>对同一行记录，写会加写锁，读会加读锁，锁级别是<strong>行锁</strong></li>
<li>当出现读写锁冲突时，后访问的事务必须等前一个事务执行完成，才能继续执行<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%isolation%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> tx_isolation  <span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="隔离级别数据形态"><a href="#隔离级别数据形态" class="headerlink" title="隔离级别数据形态"></a>隔离级别数据形态</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> T(c <span class="type">int</span>) engine<span class="operator">=</span>InnoDB;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> T(c) <span class="keyword">values</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<img src="/images/mysql-transaction-isolation/7dea45932a6b722eb069d2264d0066f8.png" alt="img" style="zoom:45%;" />

<table>
<thead>
<tr>
<th align="left">隔离级别</th>
<th align="left">V1</th>
<th align="left">V2</th>
<th align="left">V3</th>
<th align="left">实现方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">READ-UNCOMMITTED</td>
<td align="left">2</td>
<td align="left">2</td>
<td align="left">2</td>
<td align="left"><strong>没有read-view概念</strong>，直接返回<strong>记录上的最新值</strong>（<strong>内存</strong>，InnoDB Buffer Pool）</td>
</tr>
<tr>
<td align="left">READ-COMMITTED</td>
<td align="left">1</td>
<td align="left">2</td>
<td align="left">2</td>
<td align="left"><strong>每个SQL语句开始执行时</strong>创建<strong>read-view</strong>，根据read-view读取数据</td>
</tr>
<tr>
<td align="left">REPEATABLE-READ</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">2</td>
<td align="left"><strong>事务启动时</strong>创建<strong>read-view</strong>，整个事务存在期间都用这个read-view，根据read-view读取数据</td>
</tr>
<tr>
<td align="left">SERIALIZABLE</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">2</td>
<td align="left">用<strong>加锁</strong>（行锁）的方式来避免并行访问</td>
</tr>
</tbody></table>
<h2 id="Read-View"><a href="#Read-View" class="headerlink" title="Read View"></a>Read View</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>InnoDB支持MVCC多版本，其中RC（Read Committed）和RR（Repeatable Read）隔离级别是利用consistent read view（一致读视图）方式支持的。 所谓consistent read view就是在某一时刻给事务系统trx_sys打snapshot（快照），把当时trx_sys状态（包括活跃读写事务数组）记下来，之后的所有读操作根据其事务ID（即trx_id）与snapshot中的trx_sys的状态作比较，以此判断read view对于事务的可见性</p>
<h3 id="主要结构"><a href="#主要结构" class="headerlink" title="主要结构"></a>主要结构</h3><ul>
<li><strong>m_low_limit_id（低水位）</strong>：活跃事务列表里面<strong>最小的事务ID</strong></li>
<li><strong>m_up_limit_id（高水位）</strong>：当前系统已经创建的事务id的最大值+1（<strong>并不是数组内的最大</strong>）</li>
<li><strong>m_creator_trx_id（视图创建事务ID）</strong>：创建该ReadView的事务，该事务ID的数据修改可见。</li>
<li><strong>m_ids（活跃事务ID）</strong>：当快照创建时的活跃读写事务列表</li>
<li><strong>m_low_limit_no（事务number）</strong>：事务number，事务提交时候获取同时写入Undo log中的值。事务number小于该值的对该ReadView不可见。利用该信息可以Purge不需要的Undo</li>
<li><strong>m_closed</strong>： 标记该ReadView closed，用于优化减少trx_sys-&gt;mutex这把大锁的使用。可以看到在view_close的时候如果是在不持有trx_sys-&gt;mutex锁的情况下，会仅将ReadView标记为closed，并不会把ReadView从m_views的list中移除</li>
</ul>
<img src="/images/mysql-transaction-isolation/882114aaf55861832b4270d44507695e.png" alt="img" style="zoom:45%;" />

<ul>
<li><strong>行隐藏列</strong><ul>
<li>RowID：隐藏的自增ID，当建表没有指定主键，InnoDB会使用该RowID创建一个聚簇索引</li>
<li>DB_TRX_ID：最近修改（更新/删除/插入）该记录的事务ID</li>
<li>DB_ROLL_PTR：回滚指针，指向这条记录的上一个版本</li>
</ul>
</li>
</ul>
<h3 id="可见性判断"><a href="#可见性判断" class="headerlink" title="可见性判断"></a>可见性判断</h3><ul>
<li>如果记录trx_id小于m_up_limit_id或者等于m_creator_trx_id，表明ReadView创建的时候该事务已经提交，记录可见</li>
<li>如果记录的trx_id大于等于m_low_limit_id，表明事务是在ReadView创建后开启的，其修改，插入的记录不可见</li>
<li>当记录的trx_id在m_up_limit_id和m_low_limit_id之间的时候<ul>
<li>如果id在m_ids数组中，表明ReadView创建时候，事务处于活跃状态，因此记录不可见</li>
<li>如果id不在m_ids数组中，表明ReadView创建时候，事务已经提交，因此记录可见</li>
</ul>
</li>
</ul>
<h3 id="版本链"><a href="#版本链" class="headerlink" title="版本链"></a>版本链</h3><ul>
<li>在InnoDB，每个事务都有一个唯一的事务ID（transaction id）<ul>
<li>在<strong>事务开始</strong>的时候向InnoDB的<strong>事务系统</strong>申请的，<strong>按申请的顺序严格递增</strong></li>
</ul>
</li>
<li>每行数据都有多个版本，每次事务更新数据的时候，都会生成一个新的数据版本<ul>
<li>事务会把自己的transaction id赋值给这个数据版本的事务ID，记为<code>row trx_id</code><ul>
<li><strong>每个数据版本都有对应的row trx_id</strong></li>
</ul>
</li>
<li>同时也要<strong>逻辑保留</strong>旧的数据版本，通过新的数据版本和<code>undolog</code>可以<strong>计算</strong>出旧的数据版本<img src="/images/mysql-transaction-isolation/mysql-innodb-row-multi-version-20210606133912235.png" alt="img" style="zoom:45%;" /></li>
</ul>
</li>
<li>虚线框是同一行记录的4个版本</li>
<li>当前最新版本为V4，k=22，是被<code>transaction id</code>为25的事务所更新的，因此它的<code>row trx_id</code>为25虚线箭头就是undolog，而V1、V2和V3并不是物理真实存在的<ul>
<li>每次需要的时候根据<strong>当前最新版本</strong>与<code>undolog</code>计算出来的</li>
<li>例如当需要V2时，就通过V4依次执行U3和U2算出来的</li>
</ul>
</li>
</ul>
<h2 id="RR隔离的实现"><a href="#RR隔离的实现" class="headerlink" title="RR隔离的实现"></a>RR隔离的实现</h2><p>每条记录在<strong>更新</strong>的时候都会同时（<strong>在redolog和binlog提交之前</strong>）记录一条<strong>回滚操作</strong>记录上的最新值，通过回滚操作，都可以得到前一个状态的值</p>
<h2 id="事务启动"><a href="#事务启动" class="headerlink" title="事务启动"></a>事务启动</h2><ol>
<li><code>BEGIN/START TRANSACTION</code>：事务<strong>并未立马启动</strong>，在执行到后续的第一个<strong>一致性读</strong>语句，事务才真正开始</li>
<li><code>START TRANSACTION WITH CONSISTENT SNAPSHOT;</code>：事务<strong>立马启动</strong></li>
</ol>
<h2 id="执行分析"><a href="#执行分析" class="headerlink" title="执行分析"></a>执行分析</h2><p><strong>例子中如果没有特别说明，都是默认 autocommit=1</strong></p>
<h3 id="初始化表"><a href="#初始化表" class="headerlink" title="初始化表"></a>初始化表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 建表</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t` (</span><br><span class="line">    `id` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `k` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"># 表初始化</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t (id, k) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">1</span>), (<span class="number">2</span>,<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<h3 id="Demo-1"><a href="#Demo-1" class="headerlink" title="Demo-1"></a>Demo-1</h3><img src="/images/mysql-transaction-isolation/823acf76e53c0bdba7beab45e72e90d6.png" alt="img" />

<h4 id="事务A查询"><a href="#事务A查询" class="headerlink" title="事务A查询"></a>事务A查询</h4><ul>
<li><p><strong>假设</strong></p>
<ul>
<li>事务A开始前，系统里只有一个活跃事务ID是99</li>
<li>事务ABC的事务ID分别是100，101和102，且当前系统只有这4个事务</li>
<li>事务ABC开始前，<code>(1,1)</code>这一行数据的<code>row trx_id</code>是90</li>
<li>视图数组<ul>
<li>事务A：<code>[99,100]</code></li>
<li>事务B：<code>[99,100,101]</code></li>
<li>事务C：<code>[99,100,101,102]</code></li>
</ul>
</li>
<li>低水位与高水位<ul>
<li>事务A：<code>99</code>和<code>100</code></li>
<li>事务B：<code>99</code>和<code>101</code></li>
<li>事务C：<code>99</code>和<code>102</code></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>查询逻辑</strong></p>
<img src="/images/mysql-transaction-isolation/86ad7e8abe7bf16505b97718d8ac149f.png" alt="img" style="zoom:50%;" />

<p>第一个有效更新是事务C，采用当前读，读取当前最新版本<code>(1,1)</code>，改成<code>(1,2)</code></p>
<ul>
<li>此时最新版本的<code>row trx_id</code>为102，90那个版本成为历史版本<ul>
<li>由于<strong>autocommit=1</strong>，事务C在执行完更新后会立马<strong>释放</strong>id=1的<strong>行锁</strong></li>
</ul>
</li>
<li>第二个有效更新是事务B，采用当前读，读取当前最新版本<code>(1,2)</code>，改成<code>(1,3)</code><ul>
<li>此时最新版本的<code>row trx_id</code>为101，102那个版本成为历史版本</li>
</ul>
</li>
<li>事务A查询时，由于事务B还未提交，当前最新版本为<code>(1,3)</code>，对事务A是不可见的，否则就了脏读了，读取过程如下<ul>
<li>事务A的视图数组为<code>[99,100]</code>，读数据都是从<strong>当前最新版本</strong>开始读</li>
<li>首先找到当前最新版本<code>(1,3)</code>，判断<code>row trx_id</code>为101，比事务A的视图数组的高水位（100）大，<strong>不可见</strong></li>
<li>接着寻找<strong>上一历史版本</strong>，判断<code>row trx_id</code>为102，同样比事务A的视图数组的高水位（100）大，<strong>不可见</strong></li>
<li>再往前寻找，找到版本<code>(1,1)</code>，判断<code>row trx_id</code>为90，比事务A的视图数组的低水位（99）小，<strong>可见</strong></li>
<li>所以事务A的查询结果为1</li>
</ul>
</li>
<li><strong>一致性读</strong>：事务A不论在什么时候查询，看到的数据都是<strong>一致</strong>的，哪怕同一行数据同时会被其他事务更新</li>
</ul>
</li>
<li><h5 id="时间视角"><a href="#时间视角" class="headerlink" title="时间视角"></a>时间视角</h5><ul>
<li>一个数据版本，对于一个事务视图来说，除了该事务本身的更新总是可见以外，还有下面3种情况<ul>
<li>如果版本对应的事务未提交，不可见</li>
<li>如果版本对应的事务已提交，但是是在视图创建之后提交的，不可见</li>
<li><strong>如果版本对应的事务已提交，并且是在视图创建之前提交的，可见</strong></li>
</ul>
</li>
<li>归纳：<em><strong>一个事务只承认自身更新的数据版本以及视图创建之前已经提交的数据版本</strong></em></li>
<li>应用规则进行分析<ul>
<li>事务A的<strong>一致性读视图</strong>是在事务A启动时生成的，在事务A查询时</li>
<li>此时<code>(1,3)</code>的数据版本尚未提交，不可见</li>
<li>此时<code>(1,2)</code>的数据版本虽然提交了，但是是在事务A的<strong>一致性读视图</strong>创建之后提交的，不可见</li>
<li>此时<code>(1,1)</code>的数据版本是在事务A的<strong>一致性读视图</strong>创建之前提交的，可见</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>更新逻辑</strong></p>
<img src="/images/mysql-transaction-isolation/86ad7e8abe7bf16505b97718d8ac149f.png" alt="img" style="zoom:50%;" />

<ul>
<li><p>可能会产生的疑问：  </p>
<ul>
<li>事务 B 的视图数组是先生成的，之后事务 C 才提交，不是应该看不见 (1,2) 吗，怎么能算出 (1,3) ？</li>
<li>如果事务 B 在更新之前查询一次数据，这个查询返回的 k 的值确实是 1，但是，当它要去更新数据的时候，<strong>不能再在历史版本上更新</strong>，否则事务 C 的更新就丢失了</li>
</ul>
</li>
<li><p>更新数据需要先进行<strong>当前读</strong>（current read），再写入数据</p>
<ul>
<li><em><strong>当前读：总是读取已经提交的最新版本</strong></em></li>
<li><strong>当前读伴随着加锁</strong>（更新操作为<strong>X Lock模式的当前读</strong>）</li>
<li>如果当前事务在执行当前读时，其他事务在这之前已经执行了更新操作，但尚未提交（<strong>持有行锁</strong>），当前事务被阻塞</li>
</ul>
</li>
<li><p>事务B的<code>SET k=k+1</code>操作是在最新版<code>(1,2)</code>上进行的，更新后生成新的数据版本<code>(1,3)</code>，对应的<code>row trx_id</code>为101</p>
</li>
<li><p>事务B在进行后续的查询时，发现最新的数据版本为<code>101</code>，与自己的版本号<strong>一致</strong>，认可该数据版本，查询结果为3</p>
</li>
<li><p>当前读</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 查询语句</span><br><span class="line">## 读锁（S锁，共享锁）</span><br><span class="line"><span class="keyword">SELECT</span> k <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span> LOCK <span class="keyword">IN</span> SHARE MODE;</span><br><span class="line">## 写锁（X锁，排他锁）</span><br><span class="line"><span class="keyword">SELECT</span> k <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"></span><br><span class="line"># 更新语句，首先采用（X锁的）当前读</span><br></pre></td></tr></table></figure>
<h3 id="Demo-2"><a href="#Demo-2" class="headerlink" title="Demo-2"></a>Demo-2</h3><p>假设事务 C 不是马上提交的，而是变成了下面的事务 C’</p>
<img src="/images/mysql-transaction-isolation/cda2a0d7decb61e59dddc83ac51efb6e.png" /></li>
</ul>
</li>
</ul>
<img src="/images/mysql-transaction-isolation/540967ea905e8b63630e496786d84c92.png" alt="img" style="zoom:50%;" />

<ul>
<li>事务C’没有自动提交，依然持有当前最新版本版本<code>(1,2)</code>上的<strong>写锁</strong>（X Lock）</li>
<li>事务B执行更新语句，采用的是<strong>当前读</strong>（X Lock模式），会被阻塞，必须等事务C’释放这把写锁后，才能继续执行</li>
</ul>
<h2 id="RR-amp-RC"><a href="#RR-amp-RC" class="headerlink" title="RR &amp; RC"></a>RR &amp; RC</h2><h3 id="RR"><a href="#RR" class="headerlink" title="RR"></a>RR</h3><ul>
<li>RR的实现核心为<strong>一致性读</strong>（consistent read）</li>
<li>事务更新数据的时候，只能用<strong>当前读</strong>（current read）</li>
<li>如果当前的记录的行锁被其他事务占用的话，就需要进入<strong>锁等待</strong></li>
<li>在RR隔离级别下，只需要在事务<strong>启动</strong>时创建一致性读视图，之后事务里的其他查询都共用这个一致性读视图</li>
<li>对于RR，查询只承认<strong>事务启动前</strong>就已经提交的数据</li>
<li>表结构不支持RR，只支持当前读<ul>
<li>因为表结构没有对应的行数据，也没有row trx_id</li>
</ul>
</li>
</ul>
<h3 id="RC"><a href="#RC" class="headerlink" title="RC"></a>RC</h3><ul>
<li>在RC隔离级别下，每个<strong>语句执行前</strong>都会<strong>重新计算</strong>出一个新的一致性读视图</li>
<li>在RC隔离级别下，再来考虑Demo1，事务A与事务B的查询语句的结果</li>
<li><code>START TRANSACTION WITH CONSISTENT SNAPSHOT</code>的原意：创建一个持续整个事务的一致性视图<ul>
<li>在RC隔离级别下，一致性读视图会被<strong>重新计算</strong>，等同于普通的<code>START TRANSACTION</code></li>
</ul>
</li>
<li>事务A的查询语句的一致性读视图是在执行这个语句时才创建的<ul>
<li>数据版本<code>(1,3)</code>未提交，不可见</li>
<li>数据版本<code>(1,2)</code>提交了，并且在事务A<strong>当前的一致性读视图</strong>创建之前提交的，<strong>可见</strong></li>
<li>因此事务A的查询结果为2</li>
</ul>
</li>
<li>事务B的查询结果为3</li>
<li>对于RC，查询只承认<strong>语句启动前</strong>就已经提交的数据</li>
</ul>
<img src="/images/mysql-transaction-isolation/mysql-innodb-trx-rc-20210606162844432.png" alt="img" style="zoom:50%;" />

<h2 id="多版本"><a href="#多版本" class="headerlink" title="多版本"></a>多版本</h2><p>变更记录：1-&gt;2-&gt;3-&gt;4</p>
<img src="/images/mysql-transaction-isolation/mysql-read-view.png" alt="img" style="zoom:50%;" />

<ol>
<li>当前值为4，但在查询这条记录的时候，<strong>不同时刻启动的事务会有不同的视图</strong></li>
<li>在视图A、B和C，这一个记录的值分别是1、2和4</li>
<li>同一条记录在系统中可以存在多个版本，这就是<strong>MVCC</strong>（<strong>多版本并发控制</strong>）</li>
<li>对于视图A，要得到1，必须<br>将当前值依次执行图中的所有回滚操作<ul>
<li>这会存在一定的<strong>性能开销</strong></li>
<li>这里的视图是<strong>逻辑视图</strong>，<strong>并不是快照</strong></li>
<li>这里的视图是InnoDB（<strong>存储引擎层</strong>）的read-view，也不是Server层都VIEW（虚表）</li>
</ul>
</li>
<li>即使此时有另外一个事务正在将4改成5，这个事务跟视图A、B和C所对应的事务并不冲突</li>
</ol>
<h3 id="删除回滚段"><a href="#删除回滚段" class="headerlink" title="删除回滚段"></a>删除回滚段</h3><ol>
<li><strong>当没有事务需要用到这些回滚段时</strong>，回滚段就会被删除</li>
<li>不被事务所需要的回滚段：<strong>比系统中最早视图还要早的回滚段</strong></li>
</ol>
<h3 id="长事务"><a href="#长事务" class="headerlink" title="长事务"></a>长事务</h3><ol>
<li>长事务意味着系统里面存在<strong>很老的事务视图</strong></li>
<li>长事务随时可能访问数据库里面的任何数据，在这个事务提交之前，它<br>可能用到的回滚段都必须保留<ul>
<li>因此这会导致<strong>占用大量的存储空间</strong></li>
<li>&lt;= MySQL5.5，回滚段跟数据字典一起放在<strong>ibdata</strong>文件里，即使长事务最终提交，回滚段被清理，<strong>文件也不会变小</strong></li>
</ul>
</li>
<li>RC隔离级别一般不会导致回滚段过长的问题</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查询持续时间超过<span class="number">60</span>s的事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.innodb_trx <span class="keyword">where</span> TIME_TO_SEC(timediff(now(),trx_started))<span class="operator">&gt;</span><span class="number">60</span>;</span><br></pre></td></tr></table></figure>

<h2 id="事务的启动方式"><a href="#事务的启动方式" class="headerlink" title="事务的启动方式"></a>事务的启动方式</h2><ol>
<li>启动方式<ul>
<li>显式启动事务，<strong>begin(start transaction) + commit/rollback</strong></li>
<li>set autocommit=0 + commit/rollback<ul>
<li>set autocommit=0：关闭自动提交</li>
<li>一些客户端框架会在默认连接成功后执行set autocommit=0，导致<strong>接下来的查询都在事务中</strong></li>
<li>如果是<strong>长连接</strong>，就会导致<strong>意外的长事务</strong></li>
</ul>
</li>
</ul>
</li>
<li>推荐方式<ul>
<li><em><strong>set autocommit=1 + begin(start transaction) + commit/rollback</strong></em></li>
<li>set autocommit=1 + begin(start transaction) + (commit and chain)/(rollback and chain)<ul>
<li>适用于频繁使用事务的业务</li>
<li>省去再次执行begin语句的开销</li>
<li>从程序开发的角度能够明确地知道每个语句是否处于事务中</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="避免长事务的方案"><a href="#避免长事务的方案" class="headerlink" title="避免长事务的方案"></a>避免长事务的方案</h2><h3 id="应用开发端"><a href="#应用开发端" class="headerlink" title="应用开发端"></a>应用开发端</h3><ol>
<li>确保<strong>set autocommit=1</strong>，可以通过<strong>general_log</strong>来确认</li>
<li>确认程序中是否有<strong>不必要的只读事务</strong></li>
<li>业务连接数据库的时候，预估<strong>每个语句执行的最长时间</strong>（<strong>max_execution_time</strong>）</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%general_log%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name    <span class="operator">|</span> <span class="keyword">Value</span>                                         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> general_log      <span class="operator">|</span> OFF                                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> general_log_file <span class="operator">|</span> <span class="operator">/</span>data_db3<span class="operator">/</span>mysql<span class="operator">/</span><span class="number">3323</span><span class="operator">/</span>data<span class="operator">/</span>ym_DB_12_100071.log <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------------------------------------------+</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Introduced <span class="number">5.7</span><span class="number">.8</span></span><br><span class="line"># <span class="number">0</span> <span class="operator">-</span><span class="operator">&gt;</span> disable</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%max_execution_time%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name      <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> max_execution_time <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-------+</span></span><br></pre></td></tr></table></figure>

<h3 id="数据库端"><a href="#数据库端" class="headerlink" title="数据库端"></a>数据库端</h3><ol>
<li>监控<strong>information_schema.innodb_trx</strong>，设置长事务阈值，告警或者Kill（工具：pt-kill）</li>
<li>在业务功能的测试阶段要求输出所有的general_log，分析日志行为并提前发现问题</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>《MySQL实战45讲》</p>
<p><a target="_blank" rel="noopener" href="http://zhongmingmao.me/2019/01/16/mysql-transaction-isolation/">http://zhongmingmao.me/2019/01/16/mysql-transaction-isolation/</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Storage/" rel="tag"># Storage</a>
              <a href="/tags/MySQL/" rel="tag"># MySQL</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/01/04/mysql-redo-binlog/" rel="prev" title="MySQL -- redolog & binlog">
      <i class="fa fa-chevron-left"></i> MySQL -- redolog & binlog
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/01/14/mysql-index/" rel="next" title="MySQL -- 索引">
      MySQL -- 索引 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E6%A6%82%E5%BF%B5"><span class="nav-number">1.</span> <span class="nav-text">事务概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9A%94%E7%A6%BB%E6%80%A7%E4%B8%8E%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-number">2.</span> <span class="nav-text">隔离性与隔离级别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E6%95%B0%E6%8D%AE%E5%BD%A2%E6%80%81"><span class="nav-number">3.</span> <span class="nav-text">隔离级别数据形态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Read-View"><span class="nav-number">4.</span> <span class="nav-text">Read View</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5"><span class="nav-number">4.1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E7%BB%93%E6%9E%84"><span class="nav-number">4.2.</span> <span class="nav-text">主要结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E8%A7%81%E6%80%A7%E5%88%A4%E6%96%AD"><span class="nav-number">4.3.</span> <span class="nav-text">可见性判断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E9%93%BE"><span class="nav-number">4.4.</span> <span class="nav-text">版本链</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RR%E9%9A%94%E7%A6%BB%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">5.</span> <span class="nav-text">RR隔离的实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E5%90%AF%E5%8A%A8"><span class="nav-number">6.</span> <span class="nav-text">事务启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90"><span class="nav-number">7.</span> <span class="nav-text">执行分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%A1%A8"><span class="nav-number">7.1.</span> <span class="nav-text">初始化表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Demo-1"><span class="nav-number">7.2.</span> <span class="nav-text">Demo-1</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1A%E6%9F%A5%E8%AF%A2"><span class="nav-number">7.2.1.</span> <span class="nav-text">事务A查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E8%A7%86%E8%A7%92"><span class="nav-number">7.2.1.1.</span> <span class="nav-text">时间视角</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Demo-2"><span class="nav-number">7.3.</span> <span class="nav-text">Demo-2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RR-amp-RC"><span class="nav-number">8.</span> <span class="nav-text">RR &amp; RC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RR"><span class="nav-number">8.1.</span> <span class="nav-text">RR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RC"><span class="nav-number">8.2.</span> <span class="nav-text">RC</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E7%89%88%E6%9C%AC"><span class="nav-number">9.</span> <span class="nav-text">多版本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E5%9B%9E%E6%BB%9A%E6%AE%B5"><span class="nav-number">9.1.</span> <span class="nav-text">删除回滚段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%95%BF%E4%BA%8B%E5%8A%A1"><span class="nav-number">9.2.</span> <span class="nav-text">长事务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%90%AF%E5%8A%A8%E6%96%B9%E5%BC%8F"><span class="nav-number">10.</span> <span class="nav-text">事务的启动方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%81%BF%E5%85%8D%E9%95%BF%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%96%B9%E6%A1%88"><span class="nav-number">11.</span> <span class="nav-text">避免长事务的方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E7%AB%AF"><span class="nav-number">11.1.</span> <span class="nav-text">应用开发端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AB%AF"><span class="nav-number">11.2.</span> <span class="nav-text">数据库端</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">12.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="tlv"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">tlv</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tlv</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'http://example.com/2020/01/09/mysql-transaction-isolation/',]
      });
      });
  </script>

</body>
</html>
